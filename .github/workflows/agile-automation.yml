name: Agile Automation Trello & Slack

on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, closed]

jobs:
  update-trello-slack:
    runs-on: ubuntu-latest
    steps:
      # √âTAPE 1 : Extraction de l'ID Trello du message de commit
      - name: Extract Trello Card ID
        id: extract
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          echo "Analyse du message : $COMMIT_MSG"
          # Cherche le format [TRELLO-xxxx]
          CARD_ID=$(echo "$COMMIT_MSG" | grep -oP '\[TRELLO-\K[^]]+' || echo "")
          
          if [ -z "$CARD_ID" ]; then
            echo "‚ö†Ô∏è Aucun ID Trello trouv√©."
          else
            echo "‚úÖ ID trouv√© : $CARD_ID"
          fi
          echo "card_id=$CARD_ID" >> $GITHUB_OUTPUT

      # √âTAPE 2 : Ajouter un commentaire sur la carte Trello
      - name: Comment on Trello Card
        if: steps.extract.outputs.card_id != ''
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          curl -s -X POST "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/actions/comments" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            --data-urlencode "text=üíª Commit par ${{ github.actor }} : $COMMIT_MSG"

      # √âTAPE 3 : Cocher toutes les cases (Checklists)
      - name: Complete All Checklists
        if: steps.extract.outputs.card_id != ''
        run: |
          # R√©cup√®re les checklists
          CHECKLISTS=$(curl -s "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/checklists?key=${{ secrets.TRELLO_API_KEY }}&token=${{ secrets.TRELLO_TOKEN }}")
          
          # Trouve les IDs des items non coch√©s
          ITEM_IDS=$(echo "$CHECKLISTS" | jq -r '.[].checkItems[] | select(.state=="incomplete") | .id')
          
          # Coche chaque item
          for ITEM in $ITEM_IDS; do
            echo "Coche l'item : $ITEM"
            curl -s -X PUT "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/checkItem/$ITEM" \
              -d "key=${{ secrets.TRELLO_API_KEY }}" \
              -d "token=${{ secrets.TRELLO_TOKEN }}" \
              -d "state=complete" > /dev/null
          done

      # √âTAPE 4 : D√©placer la carte vers 'Termin√©'
      - name: Move Card to Done
        if: steps.extract.outputs.card_id != ''
        run: |
          # J'ai mis ici l'ID de ta liste "Termin√©" trouv√© dans ton JSON
          LIST_ID="69344363a9c1fb6f0d8f5dd9"
          
          curl -s -X PUT "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            -d "idList=$LIST_ID" \
            -d "dueComplete=true"

      # √âTAPE 5 : Notification Slack
      - name: Notify Slack
        if: steps.extract.outputs.card_id != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          # Ton ID de canal r√©cup√©r√© du lien
          channel-id: 'C0A21GNJDV4'
          slack-message: "üöÄ *Succ√®s !* La carte <https://trello.com/c/${{ steps.extract.outputs.card_id }}|Trello> a √©t√© compl√©t√©e, checklists valid√©es et archiv√©e par *${{ github.actor }}*."
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
